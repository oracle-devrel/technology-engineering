
---------------------------------------------------------------------------------
-- PARTITIONING and INDEXING
-- PURCHASEORDERS collection table 
-- JSON RELATIONAL DUALITY Views 
-- CUSTOMERS /PRODUCTS 
---------------------------------------------------------------------------------
--------------------------------------------------------------------------------
---------------------------- PARTITIONING --------------------------------------
--------------------------------------------------------------------------------
DROP TABLE ORDERS;
CREATE JSON COLLECTION TABLE ORDERS; 
INSERT INTO ORDERS SELECT * FROM PURCHASEORDERS;
ALTER TABLE ORDERS
ADD (po_num_vc NUMBER GENERATED ALWAYS AS
    (json_value (DATA, '$.PONumber.number()'
     ERROR ON ERROR)));   

ALTER TABLE ORDERS
MODIFY PARTITION BY RANGE (po_num_vc)
   (PARTITION p1 VALUES LESS THAN (1000),
    PARTITION p2 VALUES LESS THAN (2000),
    PARTITION p3 VALUES LESS THAN (3000),
    PARTITION p4 VALUES LESS THAN (4000),
    PARTITION p5 VALUES LESS THAN (5000), 
    PARTITION p6 VALUES LESS THAN (6000),
    PARTITION p7 VALUES LESS THAN (7000),
    PARTITION p8 VALUES LESS THAN (8000),
    PARTITION p9 VALUES LESS THAN (9000),
    PARTITION p10 VALUES LESS THAN (10000), 
    PARTITION p11 VALUES LESS THAN (11000)
    );

-- PARTITION PRUNNING - PARTITION 1
EXPLAIN PLAN FOR SELECT DATA FROM ORDERS
  WHERE JSON_EXISTS(DATA, '$?(@.PONumber == $V1)'
       PASSING 200 AS "V1" ); 

SELECT PLAN_TABLE_OUTPUT FROM TABLE(DBMS_XPLAN.DISPLAY());

/*
PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Plan hash value: 3905487950
 
-------------------------------------------------------------------------------------------------
| Id  | Operation              | Name   | Rows  | Bytes | Cost (%CPU)| Time     | Pstart| Pstop |
-------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT       |        |     1 |   893 |    72   (0)| 00:00:01 |       |       |
|   1 |  PARTITION RANGE SINGLE|        |     1 |   893 |    72   (0)| 00:00:01 |     1 |     1 |
|*  2 |   TABLE ACCESS FULL    | ORDERS |     1 |   893 |    72   (0)| 00:00:01 |     1 |     1 |
-------------------------------------------------------------------------------------------------
 
Predicate Information (identified by operation id):

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 
   2 - filter("ORDERS"."PO_NUM_VC"=200)

14 rows selected. 
*/
-- partition prunning  
EXPLAIN PLAN FOR SELECT DATA FROM ORDERS p
  WHERE p.data.PONumber.number() = 10000;

SELECT PLAN_TABLE_OUTPUT FROM TABLE(DBMS_XPLAN.DISPLAY());
/*
-------------------------------------------------------------------------------------------------
| Id  | Operation              | Name   | Rows  | Bytes | Cost (%CPU)| Time     | Pstart| Pstop |
-------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT       |        |     1 |   893 |    72   (0)| 00:00:01 |       |       |
|   1 |  PARTITION RANGE SINGLE|        |     1 |   893 |    72   (0)| 00:00:01 |    11 |    11 |
|*  2 |   TABLE ACCESS FULL    | ORDERS |     1 |   893 |    72   (0)| 00:00:01 |    11 |    11 |
-------------------------------------------------------------------------------------------------
 
Predicate Information (identified by operation id):

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 
   2 - filter("P"."PO_NUM_VC"=10000)

14 rows selected. 
*/
------------------------------------------ INDEXING --------------------------------------------------------------
-- Btree index
DROP INDEX po_num_idx;
CREATE UNIQUE INDEX po_num_idx ON ORDERS po
  (po.data.PONumber.number());

-- Composite Index
DROP INDEX user_cost_ctr_idx;
/*CREATE INDEX user_cost_ctr_idx ON
  ORDERS (json_value(data, '$.User' RETURNING VARCHAR2(20)),
                  json_value(data, '$.CostCenter' RETURNING VARCHAR2(6)));
*/
-- Composite index, dot notation
CREATE INDEX user_cost_ctr_idx ON
  ORDERS po (po.data."User".string(), po.data.CostCenter.string()); 
                  

-- search index
DROP INDEX po_search_idx;
CREATE SEARCH INDEX po_search_idx ON ORDERS (DATA)
  FOR JSON PARAMETERS ('MAINTENANCE AUTO');

-- dot notation

EXPLAIN PLAN FOR SELECT DATA FROM ORDERS p
  WHERE p.data.PONumber.number() = 10000;
SELECT PLAN_TABLE_OUTPUT FROM TABLE(DBMS_XPLAN.DISPLAY());
/* 
-----------------------------------------------------------------------------------------------------------------    
| Id  | Operation                          | Name       | Rows  | Bytes | Cost (%CPU)| Time     | Pstart| Pstop |    
-----------------------------------------------------------------------------------------------------------------    
|   0 | SELECT STATEMENT                   |            |     1 |   893 |     2   (0)| 00:00:01 |       |       |    
|   1 |  TABLE ACCESS BY GLOBAL INDEX ROWID| ORDERS     |     1 |   893 |     2   (0)| 00:00:01 | ROWID | ROWID |    
|*  2 |   INDEX UNIQUE SCAN                | PO_NUM_IDX |     1 |       |     1   (0)| 00:00:01 |       |       |    
-----------------------------------------------------------------------------------------------------------------    
                                                                                                                     
Predicate Information (identified by operation id):                                                                  
---------------------------------------------------                                                                  
                                                                                                                     
   2 - access(JSON_VALUE("DATA" /*+ LOB_BY_VALUE */ 
            -- FORMAT OSON , '$.PONumber.number()' RETURNING                   
            --  NUMBER NULL ON ERROR TYPE(LAX) )=10000)                                                                
--Note                                                                                                                 
   -- dynamic statistics used: dynamic sampling (level=AUTO (SYSTEM))                                                 
--19 rows selected. 

-- JSON_EXISTS in Where Clause.  PO_SEARCH_IDX chosen  
EXPLAIN PLAN FOR SELECT DATA FROM orders
  WHERE JSON_EXISTS(DATA, '$?(@.PONumber == $V1)'
       PASSING 10000 AS "V1" ); 

SELECT PLAN_TABLE_OUTPUT FROM TABLE(DBMS_XPLAN.DISPLAY());
 

/*
--------------------------------------------------------------------------------------------------------------------     
| Id  | Operation                          | Name          | Rows  | Bytes | Cost (%CPU)| Time     | Pstart| Pstop |     
--------------------------------------------------------------------------------------------------------------------     
|   0 | SELECT STATEMENT                   |               |     1 |   892 |     6   (0)| 00:00:01 |       |       |     
|*  1 |  TABLE ACCESS BY GLOBAL INDEX ROWID| ORDERS        |     1 |   892 |     6   (0)| 00:00:01 | ROWID | ROWID |     
|*  2 |   DOMAIN INDEX                     | PO_SEARCH_IDX |       |       |     4   (0)| 00:00:01 |       |       |     
--------------------------------------------------------------------------------------------------------------------     
                                                                                                                         
Predicate Information (identified by operation id):                                                                      
---------------------------------------------------                                                                      
   1 - filter(JSON_EXISTS2("DATA" /*+ LOB_BY_VALUE */ 
             -- FORMAT OSON , '$?(@.PONumber == $V1)' PASSING 10000               
             -- AS "V1" FALSE ON ERROR TYPE(LAX) )=1 AND JSON_VALUE("ORDERS"."DATA" /*+ LOB_BY_VALUE */  FORMAT OSON ,     
            --  '$.PONumber.number()' RETURNING NUMBER ERROR ON ERROR TYPE(LAX) )=10000)                                   
  -- 2 - access("CTXSYS"."CONTAINS"("ORDERS"."DATA" /*+ LOB_BY_VALUE */                                                    
   --           ,'(sdata(FNUM_F9A83D1D49108EE786CEBB9017653F0E_PONumber  = 10000 ))')>0)                                   

--18 rows selected. 

EXPLAIN PLAN FOR 
SELECT data FROM orders
  WHERE json_value(data, '$.User') = 'ABULL'
    AND json_value(data, '$.CostCenter') = 'A50';
SELECT PLAN_TABLE_OUTPUT FROM TABLE(DBMS_XPLAN.DISPLAY());

/* 
--------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation                                  | Name              | Rows  | Bytes | Cost (%CPU)| Time     | Pstart| Pstop |
--------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT                           |                   |    80 | 74640 |    68   (0)| 00:00:01 |       |       |
|   1 |  TABLE ACCESS BY GLOBAL INDEX ROWID BATCHED| ORDERS            |    80 | 74640 |    68   (0)| 00:00:01 | ROWID | ROWID |
|*  2 |   INDEX RANGE SCAN                         | USER_COST_CTR_IDX |    85 |       |     1   (0)| 00:00:01 |       |       |
--------------------------------------------------------------------------------------------------------------------------------
 
Predicate Information (identified by operation id):

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 
   2 - access(JSON_VALUE("DATA" /*+ LOB_BY_VALUE */ 
             -- FORMAT OSON , '$."User".string()' RETURNING VARCHAR2(4000) NULL ON 
             -- ERROR TYPE(LAX) )='ABULL' AND JSON_VALUE("DATA" /*+ LOB_BY_VALUE */  FORMAT OSON , '$.CostCenter.string()' RETURNING 
             -- VARCHAR2(4000) NULL ON ERROR TYPE(LAX) )='A50')
 
 


EXPLAIN PLAN FOR 
SELECT data FROM orders p
  WHERE p.data."User" = 'ABULL' AND p.data.CostCenter = 'A50';
SELECT PLAN_TABLE_OUTPUT FROM TABLE(DBMS_XPLAN.DISPLAY());

/* 
--------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation                                  | Name              | Rows  | Bytes | Cost (%CPU)| Time     | Pstart| Pstop |
--------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT                           |                   |    80 | 74640 |    71   (0)| 00:00:01 |       |       |
|*  1 |  TABLE ACCESS BY GLOBAL INDEX ROWID BATCHED| ORDERS            |    80 | 74640 |    71   (0)| 00:00:01 | ROWID | ROWID |
|*  2 |   INDEX RANGE SCAN                         | USER_COST_CTR_IDX |    85 |       |     1   (0)| 00:00:01 |       |       |
--------------------------------------------------------------------------------------------------------------------------------
 
Predicate Information (identified by operation id):

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 
   1 - filter(JSON_VALUE("P"."DATA" /*+ LOB_BY_VALUE */
              --  FORMAT OSON , '$."User"' RETURNING VARCHAR2(4000) NULL ON 
--              ERROR TYPE(STRICT) )='ABULL' AND JSON_VALUE("P"."DATA" /*+ LOB_BY_VALUE */  FORMAT OSON , '$.CostCenter' RETURNING 
--              VARCHAR2(4000) NULL ON ERROR TYPE(STRICT) )='A50')
--   2 - access(JSON_VALUE("DATA" /*+ LOB_BY_VALUE */  FORMAT OSON , '$."User".string()' RETURNING VARCHAR2(4000) NULL ON 
--              ERROR TYPE(LAX) )='ABULL' AND JSON_VALUE("DATA" /*+ LOB_BY_VALUE */  FORMAT OSON , '$.CostCenter.string()' RETURNING 
--              VARCHAR2(4000) NULL ON ERROR TYPE(LAX) )='A50')
 
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- dynamic statistics used: dynamic sampling (level=AUTO (SYSTEM))

-- 23 rows selected. 

--------------------------------------------------------------------------------
---------------------------- PARTIAL INDEX FOR JSON-----------------------------
--------------------------------------------------------------------------------
drop table COFFEE purge;

create JSON collection table COFFEE (price_vc NUMBER GENERATED ALWAYS AS (json_value (DATA, '$.price.number()' ERROR ON ERROR)))
  PARTITION BY RANGE (price_vc)
   (PARTITION p1 VALUES LESS THAN (6),
    PARTITION p2 VALUES LESS THAN (10),
    PARTITION p3 VALUES LESS THAN (MAXVALUE));

insert into COFFEE values (json{ '_id' : 1, 'item' : 'Americanos', 'price' : 7, 'size': 'Short', 'quantity' : 15 });
insert into COFFEE values (json{ '_id' : 2, 'item' : 'Espresso', 'price' : 5, 'size': 'Short', 'quantity' : 22,
'CoffeeItems' : [{ 'Details'     : { 'Description' : 'Italian Espresso',
                                'UnitPrice'   : 5,
                                'Code'        : 28995},
                   'Quantity' : 9.0 },
                 { 'Details'     : { 'Description' : 'Finnish Espresso',
                                'UnitPrice'   : 5,
                                'Code'        : 28996},
                   'Quantity' : 13.0 } ] });
commit work;

-- Partial index for JSON:
DROP INDEX coffee_price_idx;
CREATE INDEX coffee_price_idx on COFFEE(CASE WHEN JSON_VALUE(data, '$.price') <=5 THEN JSON_VALUE(data, '$.price' RETURNING NUMBER ERROR ON ERROR) ELSE NULL END);

DROP INDEX coffee_price_vc_idx;
CREATE INDEX coffee_price_vc_idx on COFFEE(CASE WHEN JSON_VALUE(data, '$.price_vc') <=5 THEN JSON_VALUE(data, '$.price_vc' RETURNING NUMBER ERROR ON ERROR) ELSE NULL END);


SELECT DATA FROM COFFEE s WHERE s.data.price.number() = 7;
explain plan for SELECT DATA FROM COFFEE s WHERE s.data.price.number() = 7;
select * from dbms_xplan.display();


/* 
PLAN_TABLE_OUTPUT                                                                                        
________________________________________________________________________________________________________ 
Plan hash value: 853691940                                                                               
                                                                                                         
-----------------------------------------------------------------------------------------------------    
| Id  | Operation                  | Name   | Rows  | Bytes | Cost (%CPU)| Time     | Pstart| Pstop |    
-----------------------------------------------------------------------------------------------------    
|   0 | SELECT STATEMENT           |        |     1 | 20500 |   274   (0)| 00:00:01 |       |       |    
|   1 |  PARTITION RANGE SINGLE    |        |     1 | 20500 |   274   (0)| 00:00:01 |     2 |     2 |    
|*  2 |   TABLE ACCESS STORAGE FULL| COFFEE |     1 | 20500 |   274   (0)| 00:00:01 |     2 |     2 |    
-----------------------------------------------------------------------------------------------------    
                                                                                                         
Predicate Information (identified by operation id):                                                      
---------------------------------------------------                                                      
                                                                                                         
   2 - storage("S"."PRICE_VC"=7)                                                                         
       filter("S"."PRICE_VC"=7)                                                                          
                                                                                                         
Note                                                                                                     
-----                                                                                                    
   - dynamic statistics used: dynamic sampling (level=2)                                                 
   - automatic DOP: Computed Degree of Parallelism is 1 because of no expensive parallel operation       

20 rows selected. 

*/


--------------------------------------------------------------------------------
---------------------------- DBMS_SQLDIAG --------------------------------------
--------------------------------------------------------------------------------
-- dbms_sqldiag.report_sql 

set feedback on sql_id
SELECT data FROM orders
  WHERE json_value(data, '$.User') = 'ABULL'
    AND json_value(data, '$.CostCenter') = 'A50';

/* 
{"_id":"66cd794eca37168420771fea","CostCenter":"A50","PONumber":8358,"Reference":"ABULL-20140509","Requestor":"Alexis Bull","Special Instructions":"Ground","User":"ABULL","ShippingInstructions":{"name":"Alexis Bull","Address":{"city":"South San Francisco","country":"United States of America","state":"CA","street":"200 Sporting Green","zipCode":99236},"Phone":[{"number":"70-555-4236","type":"Office"}]},"LineItems":[{"ItemNumber":1,"Quantity":9,"Part":{"Description":"30th Anniversary of Rock 'N Roll All Star Jam With Bo Diddley","UPCCode":13023010192,"UnitPrice":19.95}},{"ItemNumber":2,"Quantity":4,"Part":{"Description":"All Quiet on the Western Front","UPCCode":25192051029,"UnitPrice":19.95}},{"ItemNumber":3,"Quantity":8,"Part":{"Description":"Malice","UPCCode":27616854780,"UnitPrice":19.95}},{"ItemNumber":4,"Quantity":5,"Part":{"Description":"There's No Business Like Show Business","UPCCode":24543014454,"UnitPrice":19.95}}]}
{"_id":"66cd794eca37168420771f90","CostCenter":"A50","PONumber":8328,"Reference":"ABULL-20140504","Requestor":"Alexis Bull","Special Instructions":"Counter to Counter","User":"ABULL","ShippingInstructions":{"name":"Alexis Bull","Address":{"city":"South San Francisco","country":"United States of America","state":"CA","street":"200 Sporting Green","zipCode":99236},"Phone":[{"number":"25-41-3537","type":"Office"}]},"LineItems":[{"ItemNumber":1,"Quantity":3,"Part":{"Description":"Mark Messier- Leader, Champion and Legend","UPCCode":696306000327,"UnitPrice":19.95}},{"ItemNumber":2,"Quantity":4,"Part":{"Description":"The Prophecy","UPCCode":717951001580,"UnitPrice":19.95}},{"ItemNumber":3,"Quantity":1,"Part":{"Description":"Pokemon: Johto Journeys- Team Green / Japanimat","UPCCode":13023156999,"UnitPrice":27.95}},{"ItemNumber":4,"Quantity":6,"Part":{"Description":"Airport 1975","UPCCode":18713810106,"UnitPrice":19.95}},{"ItemNumber":5,"Quantity":4,"Part":{"Description":"What Dreams May Come","UPCCode":44005827521,"UnitPrice":19.95}}]}
{"_id":"66cd794eca37168420772683","CostCenter":"A50","PONumber":8921,"Reference":"ABULL-20141101","Requestor":"Alexis Bull","Special Instructions":"Counter to Counter","User":"ABULL","ShippingInstructions":{"name":"Alexis Bull","Address":{"city":"South San Francisco","country":"United States of America","state":"CA","street":"200 Sporting Green","zipCode":99236},"Phone":[{"number":"416-555-767","type":"Office"}]},"LineItems":[{"ItemNumber":1,"Quantity":6,"Part":{"Description":"Iron Eagle","UPCCode":43396839694,"UnitPrice":19.95}},{"ItemNumber":2,"Quantity":8,"Part":{"Description":"The Siege","UPCCode":24543010913,"UnitPrice":19.95}},{"ItemNumber":3,"Quantity":2,"Part":{"Description":"Backdraft","UPCCode":25192004124,"UnitPrice":19.95}},{"ItemNumber":4,"Quantity":6,"Part":{"Description":"Truck Turner","UPCCode":27616857910,"UnitPrice":19.95}}]}
{"_id":"66cd794eca37168420772686","CostCenter":"A50","PONumber":8922,"Reference":"ABULL-20141102","Requestor":"Alexis Bull","Special Instructions":"Hand Carry","User":"ABULL","ShippingInstructions":{"name":"Alexis Bull","Address":{"city":"South San Francisco","country":"United States of America","state":"CA","street":"200 Sporting Green","zipCode":99236},"Phone":[{"number":"78-555-8375","type":"Office"}]},"LineItems":[{"ItemNumber":1,"Quantity":1,"Part":{"Description":"The Delta Force","UPCCode":27616852892,"UnitPrice":19.95}},{"ItemNumber":2,"Quantity":1,"Part":{"Description":"Apocalypse Now Redux","UPCCode":97360962949,"UnitPrice":32.95}},{"ItemNumber":3,"Quantity":7,"Part":{"Description":"Doctor Who: The Five Doctors","UPCCode":794051159625,"UnitPrice":27.95}}]}
{"_id":"66cd794eca37168420772689","CostCenter":"A50","PONumber":8923,"Reference":"ABULL-20141107","Requestor":"Alexis Bull","Special Instructions":"Courier","User":"ABULL","ShippingInstructions":{"name":"Alexis Bull","Address":{"city":"South San Francisco","country":"United States of America","state":"CA","street":"200 Sporting Green","zipCode":99236},"Phone":[{"number":"600-555-9900","type":"Office"}]},"LineItems":[{"ItemNumber":1,"Quantity":6,"Part":{"Description":"Fela Live!- Fela Anikulapo-Kuti and the Egypt 80 Band","UPCCode":16351010193,"UnitPrice":19.95}},{"ItemNumber":2,"Quantity":3,"Part":{"Description":"Herbie Mann: Jasil Brass","UPCCode":13023034495,"UnitPrice":19.95}},{"ItemNumber":3,"Quantity":7,"Part":{"Description":"Eraser","UPCCode":85391420224,"UnitPrice":19.95}}]}
{"_id":"66cd794eca3716842077268c","CostCenter":"A50","PONumber":8924,"Reference":"ABULL-20141109","Requestor":"Alexis Bull","Special Instructions":"Courier","User":"ABULL","ShippingInstructions":{"name":"Alexis Bull","Address":{"city":"South San Francisco","country":"United States of America","state":"CA","street":"200 Sporting Green","zipCode":99236},"Phone":[{"number":"728-555-9686","type":"Office"}]},"LineItems":[{"ItemNumber":1,"Quantity":5,"Part":{"Description":"Support Your Local Gunfighter","UPCCode":27616859051,"UnitPrice":19.95}},{"ItemNumber":2,"Quantity":4,"Part":{"Description":"The Four Sided Triangle","UPCCode":13131107593,"UnitPrice":19.95}},{"ItemNumber":3,"Quantity":6,"Part":{"Description":"Devil in a Blue Dress","UPCCode":43396513495,"UnitPrice":19.95}},{"ItemNumber":4,"Quantity":7,"Part":{"Description":"Nothing But Trouble","UPCCode":85391637622,"UnitPrice":19.95}},{"ItemNumber":5,"Quantity":2,"Part":{"Description":"A View to a Kill","UPCCode":27616853967,"UnitPrice":19.95}}]}
{"_id":"66cd794eca3716842077331c","CostCenter":"A50","PONumber":9996,"Reference":"ABULL-20141025","Requestor":"Alexis Bull","Special Instructions":"Courier","User":"ABULL","ShippingInstructions":{"name":"Alexis Bull","Address":{"city":"South San Francisco","country":"United States of America","state":"CA","street":"200 Sporting Green","zipCode":99236},"Phone":[{"number":"796-555-5448","type":"Office"}]},"LineItems":[{"ItemNumber":1,"Quantity":5,"Part":{"Description":"Ancient Secrets of Bible: David / Samson","UPCCode":56775056797,"UnitPrice":19.95}},{"ItemNumber":2,"Quantity":9,"Part":{"Description":"Stomp Out Loud","UPCCode":26359148422,"UnitPrice":19.95}},{"ItemNumber":3,"Quantity":4,"Part":{"Description":"The Mosquito Coast","UPCCode":85393622121,"UnitPrice":19.95}}]}
{"_id":"66cd794eca3716842077316c","CostCenter":"A50","PONumber":9852,"Reference":"ABULL-20141001","Requestor":"Alexis Bull","Special Instructions":"Expidite","User":"ABULL","ShippingInstructions":{"name":"Alexis Bull","Address":{"city":"South San Francisco","country":"United States of America","state":"CA","street":"200 Sporting Green","zipCode":99236},"Phone":[{"number":"604-555-550","type":"Office"}]},"LineItems":[{"ItemNumber":1,"Quantity":2,"Part":{"Description":"I Spy: Blackout","UPCCode":14381983425,"UnitPrice":19.95}},{"ItemNumber":2,"Quantity":6,"Part":{"Description":"The Prophecy","UPCCode":717951001580,"UnitPrice":19.95}},{"ItemNumber":3,"Quantity":4,"Part":{"Description":"Kingpin","UPCCode":27616627520,"UnitPrice":19.95}}]}
{"_id":"66cd794eca3716842077316f","CostCenter":"A50","PONumber":9853,"Reference":"ABULL-20141001","Requestor":"Alexis Bull","Special Instructions":"Expidite","User":"ABULL","ShippingInstructions":{"name":"Alexis Bull","Address":{"city":"South San Francisco","country":"United States of America","state":"CA","street":"200 Sporting Green","zipCode":99236},"Phone":[{"number":"670-555-5384","type":"Office"}]},"LineItems":[{"ItemNumber":1,"Quantity":3,"Part":{"Description":"Switch","UPCCode":26359055027,"UnitPrice":19.95}},{"ItemNumber":2,"Quantity":2,"Part":{"Description":"Grosse Point & High Fidelity","UPCCode":786936161328,"UnitPrice":32.95}},{"ItemNumber":3,"Quantity":5,"Part":{"Description":"Mysteries & Myths Of 20th Century 3","UPCCode":56775042998,"UnitPrice":19.95}}]}
{"_id":"66cd794eca37168420773172","CostCenter":"A50","PONumber":9854,"Reference":"ABULL-20141006","Requestor":"Alexis Bull","Special Instructions":"Surface Mail","User":"ABULL","ShippingInstructions":{"name":"Alexis Bull","Address":{"city":"South San Francisco","country":"United States of America","state":"CA","street":"200 Sporting Green","zipCode":99236},"Phone":[{"number":"284-555-8087","type":"Office"}]},"LineItems":[{"ItemNumber":1,"Quantity":1,"Part":{"Description":"Jackie Chan's First Strike","UPCCode":794043466922,"UnitPrice":19.95}},{"ItemNumber":2,"Quantity":5,"Part":{"Description":"Pecker","UPCCode":794043473128,"UnitPrice":19.95}},{"ItemNumber":3,"Quantity":1,"Part":{"Description":"Plenty","UPCCode":17153111903,"UnitPrice":19.95}},{"ItemNumber":4,"Quantity":1,"Part":{"Description":"Deathtrap","UPCCode":85391125624,"UnitPrice":19.95}}]}

85 rows selected. 



SQL_ID: 8zqk5j2jzta0r
*/
-- insert the report into a CLOB variable
set feedback on
var report clob;
exec :report := dbms_sqldiag.report_sql('8zqk5j2jzta0r');
--spool the file
set trimspool on
set TRIM on
 set pagesize 0
set pagesize 0
set linesize 32767
set long 1000000
set longchunksize 1000000

spool diagsql1.html
select :report report FROM dual;
spool off

